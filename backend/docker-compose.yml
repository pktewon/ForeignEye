version: '3.8'

services:
  # 1. 백엔드 (Flask/Gunicorn) 서비스
  backend:
    build: .  # 현재 폴더의 Dockerfile을 사용
    container_name: foreigneye_backend
    ports:
      - "8000:8000"  # 로컬 8000번 포트를 컨테이너 8000번 포트에 연결
    env_file:
      - .env.prod    # 2단계에서 만든 프로덕션 환경 변수 파일을 주입
    depends_on:
      - db           # DB 컨테이너가 먼저 실행되도록 설정
    restart: always

  # 2. MySQL 데이터베이스 서비스
  db:
    image: mysql:8.0
    container_name: foreigneye_db
    environment:
      # .env.prod 파일과 일치해야 합니다.
      MYSQL_ROOT_PASSWORD: kCimsBuMV0ozcHaY2XItIBzszeKHXvcO
      MYSQL_DATABASE: foreigneye_db
      MYSQL_USER: foreigneye_user
      MYSQL_PASSWORD: mwd1z72wq-YUqrMpWUV7ZHumSIABXmAY
    volumes:
      - foreigneye_db_data:/var/lib/mysql # 데이터 영속성 유지
    ports:
      - "3307:3306"  # 로컬 3306과 충돌을 피하기 위해 3307로 노출
    restart: always

# Docker가 관리하는 볼륨 정의 (데이터 영속성)
volumes:
  foreigneye_db_data: